## Architecture

### Backend

Change ProjectName or <ProjectName> to your desired name in the following instances:
```
django/
         manage.py
         ProjectName/   <--- RENAME
                 __init__.py
                 settings.py
                 urls.py
                 wsgi.py
```
#### settings.py
``` python
ROOT_URLCONF = 'NewProjectName.urls'
WSGI_APPLICATION = 'NewProjectName.wsgi.application'
SWAGGER_SETTINGS = { 'DEFAULT_INFO': 'NewProjectName.urls.api_info' }
```
#### wsgi.py
``` python
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "NewProjectName.settings")
```
#### manage.py
``` python
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "NewProjectName.settings")
```
#### celery.py
``` python
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "NewProjectName.settings")
app = Celery("NewProjectName", set_as_current=True)
```
#### pytest.ini
```
DJANGO_SETTINGS_MODULE=NewProjectName.settings
```

#### dotenv
We use .env settings for the private settings, there's a template for it called .env.template
```
cp .env.template .env
```

#### Docker Compose
We use docker compose to orchestrate our architecture, issue the following commands to build and download all the containers needed.
```
docker-compose build
docker-compose up
```

#### creating a virtualenv
```
mkvirtualenv mkvirtualenv --python=`which python3` v-env-name
workon v-env-name
```

#### local scripts and remote execution with Fabric3
Use the `fab` command from the project root. Use a virtualenv, like specified above.
```
pip install -r ../requirements_local.txt
```

#### OpenAPI Schema generator and change reviewer
This will generate swagger.json and see if anything changed in your endpoints.
Use this to inform the frontend team that something's been changed, added, removed.
```
fab openapi
```

#### PR/Migrations strategy
* IF your PR contains DATA migrations, `COMMIT` all the migrations in your branch
* Data migrations MUST NOT containt the string `# Generated by Django` else CircleCI will fail
* IF your PR contains autogenerated SCHEMA migrations (with `makemigrations`):
    1. DO NOT `COMMIT` any migrations to the PR, but push everything else
    2. If the PR is green, ask a reviewer for a review
* IF you are reviewing a PR:
    * Decline any PRs that have migration files
    * If you want to try the code out:
        1. checkout `branch`
        2. run `fab makemigrations`
        3. run `fab migrate`
        4. review the code and data consistency
    * Merge PR then:
        1. run `fab makemigrations`
        2. run `fab migrate`
        3. `commit` and `push` migrations
* IF you are the one whose PR got merged or you are the reviewer who checked out the code
and migrations and want to keep data:
    * `migrate --fake` the migrations, because they already exist in your DB

#### SSL setup through Docker-Compose with certbot
[Tutorial](https://medium.com/@pentacent/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71)

### Frontend

This is a project based on [NuxtJS](https://nuxtjs.org/) and [Element](https://element.eleme.io/#/en-US) UI library.

#### Requirements

It is recommended to prepare the following tools and packages.

- [yarn](https://yarnpkg.com/), default package manager for our projects.
- [Visual studio code](https://code.visualstudio.com/), recommended, not an obligation. Recommended extensions:
  - [ESLint]()
  - [GitLens]()
  - [Prettier]()
  - [Vue Peek]()
  - [Markdown Preview Github Styling]() to help in making nice technical documentations (like this)
- [nvm](https://github.com/nvm-sh/nvm) is node version manager that will allow you to manage your node versions easily for projects with a `.nvmrc` attach to it (our projects). For a deeper integration and automated use of `nvm use` when you enter in the project folder, check [this](https://github.com/nvm-sh/nvm#deeper-shell-integration) out. (this is not working on Windows machines though)
- [Docker](https://www.docker.com/), we use docker a lot.
- On Windows machines further tools are needed
  - [Power Shell 7](https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-windows) because of proper UTF-8 handling (sql dumps and other scripts)

#### Quick Frontend Setup

``` bash
# install dependencies
$ yarn install

# serve with hot reload at localhost:3000
$ yarn dev

# build for production and launch server
$ yarn build
$ yarn start
```

#### .env template

HOST=localhost  
PORT=3000  
NODE_ENV=dev  
SENTRY_PUBLIC_DSN=""  
SENTRY_DSN=""  
AZURE_CLIENT_ID=  
AZURE_REDIRECT_URI=  
AZURE_TENANT=  
MATOMO_URL=  
MATOMO_SITEID=  
MATOMO_DEBUG=